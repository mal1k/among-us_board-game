<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="games.webmanifest">
    <script
    src="https://code.jquery.com/jquery-3.6.0.js"
    integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk="
    crossorigin="anonymous"></script>
    
    <title>Lobby</title>
</head>
<body>

<section style="text-align: center;top: 0;position: absolute;left: 0;right: 0;">
    <p id="lobbyName" style="font-family: Arial;color: white;font-size: 18px;margin-top: 3px;">Лобби игры
        <p style="font-family: Arial;color: white;font-size: 18px;position: absolute;top: 5px;left: 0;right: 0;">Код игры: <span id="gameCode"></span></p>
    </p>
    <div class="progressbarWrapper">
        
        <p style="
            font-family: Arial;
            font-size: 24px;
            top: 0;
            margin-top: 0px;
            color: rgb(5, 165, 5);
            font-weight: 600;">Прогресс бар</p>
      <span id="greenBar" class="greenBarText" style="width: 0%"></span>
    </div>
</section>

<!-- content -->
    <!-- impostor -->
    <section id="impostorSection">
        <!-- <button style="width: 83.5%;margin-bottom: 10px;">Убить игрока</button> -->
        <select style="width: 83.5%;margin-bottom: 10px;width: 90%;text-align: center;" name="" id="playerColor">
            <option selected disabled>Убить игрока</option>
            <option id="color1" value="1">Красный</option>
            <option id="color2" value="2">Оранжевый</option>
            <option id="color3" value="3">Коричневый</option>
            <option id="color4" value="4">Желтый</option>
            <option id="color5" value="5">Салатовый</option>
            <option id="color6" value="6">Зеленый</option>
            <option id="color7" value="7">Голубой</option>
            <option id="color8" value="8">Синий</option>
            <option id="color9" value="9">Розовый</option>
            <option id="color10" value="10">Фиолетовый</option>
            <option id="color11" value="11">Черный</option>
            <option id="color12" value="12">Белый</option>
        </select>

        <button style="left: 0;width: 40%;margin-right: 10px;background: #cc55ff;padding: 10px 0;">Саботаж верхнего крыла</button>
        <button style="right: 0;width: 40%;background: #5594ff;padding: 10px 0;">Саботаж нижнего крыла</button>
    </section>

    <!-- player -->
    <section id="playerTaskSection">
        <p style="font-size: 24px;margin: 0;">Задания:</p>
        <ul id="playerTasksList" style="line-height: 32px;text-align: left;font-size: 18px;">
        </ul>
    </section>

    <!-- wait til start -->
    <section id="waitTillStartSection" style="height: 45%; overflow-y: auto;">
        <p style="font-size: 24px;margin: 0;">Ожидайте начала игры</p>
        <ul style="line-height: 32px;text-align: left;font-size: 18px;" id="playersList">
        </ul>
    </section>


<section style="left: 0;right: 0;bottom: 10px;position: absolute;text-align: center;">
    <button id="sosButton" style="width: 80%;font-size: 18px;background: rgb(255, 85, 85);">Экстренное совещание</button>
    <form id="startGame">
        <button type="submit" style="background: rgb(5, 165, 5);">Начать игру</button>
    </form>
    
    <button id="lobbyLogout" style="margin-top: 10px; font-size: 16px;">Выйти из игры</button>
</section>

<script>
let lobbyID = localStorage.getItem('amongus-gameCode');
let playerName = localStorage.getItem('amongus-playerName');
let gameName = localStorage.getItem('amongus-gameName');
let impostor = $("#impostorSection");
let player = $("#playerTaskSection");
let notStarted = $("#waitTillStartSection");
let startGameButton = $("#startGame");
let sosButton = $("#sosButton");

sosButton.click(function (event) {
    var formData = {
        text: "Начато экстренное совещание",
        name: gameName,
    };

    if (! sosButton.hasClass('pause') ) {
        $.ajax({
            type: "POST",
            url: "http://api.board-game.space/api/among-us/send-telegram",
            data: formData,
            dataType: "json",
            encode: true,
        }).done(function (data) {
            jQuery(sosButton).addClass("pause");
            var _Seconds = 120;
            int = setInterval(function() {
            if (_Seconds > 0) {
                _Seconds--; // вычитаем 1
                sosButton.text(_Seconds);
            } else {
                jQuery(sosButton).removeClass("pause");
                clearInterval(int); // очищаем интервал, чтобы он не продолжал работу при _Seconds = 0
                sosButton.text("Экстренное совещание");
            }
            }, 1000);
        });
    }

});

$("#gameCode").text(lobbyID);
$("#lobbyName").text(gameName);

$("#startGame").submit(function (event) {
    var formData = {
        lobbyID: lobbyID,
        name: $("#name").val(),
        impostor: $("#impostors").val(),
    };

    $.ajax({
        type: "POST",
        url: "http://api.board-game.space/api/among-us/start-lobby",
        data: formData,
        dataType: "json",
        encode: true,
    }).done(function (data) {
        notStarted.hide();
        player.show();

        startGameButton.hide();
        sosButton.show();
    });

    event.preventDefault();
});

$("#lobbyLogout").click(function (event) {
    var formData = {
        lobbyID: lobbyID,
        name: playerName,
    };

    $.ajax({
        type: "POST",
        url: "http://api.board-game.space/api/among-us/lobby-logout",
        data: formData,
        dataType: "json",
        encode: true,
    }).done(function (data) {
        window.location.href = "/";
    });

    event.preventDefault();
});


var colors = {
    1: 'Красный',
    2: 'Оранжевый',
    3: 'Коричневый',
    4: 'Желтый',
    5: 'Салатовый',
    6: 'Зеленый',
    7: 'Голубой',
    8: 'Синий',
    9: 'Розовый',
    10: 'Фиолетовый',
    11: 'Черный',
    12: 'Белый'
}

function fetchdata(){
var formData = {
    lobbyID: lobbyID,
    name: playerName,
};
var array = [];
var new_array = [];

$.ajax({
    type: "POST",
    url: "http://api.board-game.space/api/among-us/get-lobby",
    data: formData,
    dataType: "json",
    encode: true,

    success: function(data){
      localStorage.setItem('amongus-gameStatus', data.started);
    }
});

 $.ajax({
    type: "POST",
    url: "http://api.board-game.space/api/among-us/get-players",
    data: formData,
    dataType: "json",
    encode: true,

    success: function(data){
        $("#playersList").empty();
        let gameStatus = localStorage.getItem('amongus-gameStatus');
        $.each(data, function( index, value ) {
            $("#playersList").append("<li>" + colors[value.color] + " | " + value.name + "</li>");
            if ( gameStatus == 1 ) {
                if ( value.name == playerName ) {
                    if ( value.is_impostor == 1 ) {
                        notStarted.hide();
                        player.hide();
                        impostor.show();
                    } else {
                        notStarted.hide();
                        impostor.hide();
                        player.show();
                    }
                    startGameButton.hide();
                    sosButton.show();
                }
            }
        });
    }
 });

 $.ajax({
    type: "POST",
    url: "http://api.board-game.space/api/among-us/get-tasks",
    data: formData,
    dataType: "json",
    encode: true,

    success: function(data){
      $("#playerTasksList").empty();
      $.each(data, function( index, value ) {
          if ( value.done )
            $("#playerTasksList").append("<li style='color: rgb(5, 165, 5);'>" + value.task + "</li>");
            $("#playerTasksList").append("<li>" + value.task + "</li>");

            // if ( gameStatus == 1 ) {
            //     if ( value.name == playerName ) {
            //         if ( value.is_impostor == 1 ) {
            //             notStarted.hide();
            //             player.hide();
            //             impostor.show();
            //         } else {
            //             notStarted.hide();
            //             impostor.hide();
            //             player.show();
            //         }
            //         startGameButton.hide();
            //         sosButton.show();
            //     }
            // }
        });
    },
    complete:function(data){
      setTimeout(fetchdata,1000);
    }
});

}

$(document).ready(function(){
 setTimeout(fetchdata,0);
});


function move() {
  let elem = document.getElementById("greenBar");
  let stepValue = 20;
  let id = setInterval(frame, 500);

  function frame() {
    if (stepValue >= 100) {
      clearInterval(id);
    } else {
      elem.style.width = stepValue + 10 + "%";
      elem.innerHTML = stepValue + 10 + "%";
      stepValue = stepValue + 10;
    }
  }
}

</script>
    
</body>
</html>