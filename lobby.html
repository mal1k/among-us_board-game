<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="games.webmanifest">
    <script
    src="https://code.jquery.com/jquery-3.6.0.js"
    integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk="
    crossorigin="anonymous"></script>
    
    <title>Lobby</title>
</head>
<body>

<section style="text-align: center;top: 0;position: absolute;left: 0;right: 0;">
    <p id="lobbyName" style="font-family: Arial;color: white;font-size: 18px;margin-top: 3px;">–õ–æ–±–±–∏ –∏–≥—Ä—ã
        <p style="font-family: Arial;color: white;font-size: 18px;position: absolute;top: 5px;left: 0;right: 0;">–ö–æ–¥ –∏–≥—Ä—ã: <span id="gameCode"></span></p>
    </p>
    <div class="progressbarWrapper">
        
        <p id="progressBarText" style="
            font-family: Arial;
            font-size: 24px;
            top: 0;
            margin-top: 0px;
            color: rgb(5, 165, 5);
            font-weight: 600;">–ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä</p>
      <span id="greenBar" class="greenBarText" style="width: 0%"></span>
    </div>
</section>

<!-- content -->
    <!-- impostor -->
    <section id="impostorSection">
        <!-- <button style="width: 83.5%;margin-bottom: 10px;">–£–±–∏—Ç—å –∏–≥—Ä–æ–∫–∞</button> -->
        <select style="width: 83.5%;margin-bottom: 10px;width: 90%;text-align: center;" name="" id="killPlayer">
            <option selected disabled>–£–±–∏—Ç—å –∏–≥—Ä–æ–∫–∞</option>

        </select>

        <button id="sabotage0" style="right: 0;width: 40%;background: #5594ff;padding: 10px 0;">–°–∞–±–æ—Ç–∞–∂ –Ω–∏–∂–Ω–µ–≥–æ –∫—Ä—ã–ª–∞</button>
        <button id="sabotage1" style="left: 0;width: 40%;margin-right: 10px;background: #cc55ff;padding: 10px 0;">–°–∞–±–æ—Ç–∞–∂ –≤–µ—Ä—Ö–Ω–µ–≥–æ –∫—Ä—ã–ª–∞</button>
    </section>

    <!-- player -->
    <section id="playerTaskSection">
        <p id="tasksText" style="font-size: 24px;margin: 0;">–ó–∞–¥–∞–Ω–∏—è:</p>
        <ul id="playerTasksList" style="line-height: 32px;text-align: left;font-size: 18px;">
        </ul>
    </section>

    <!-- wait til start -->
    <section id="waitTillStartSection" style="height: 45%; overflow-y: auto;">
        <p style="font-size: 24px;margin: 0;">–û–∂–∏–¥–∞–π—Ç–µ –Ω–∞—á–∞–ª–∞ –∏–≥—Ä—ã</p>
        <ul style="line-height: 32px;text-align: left;font-size: 18px;" id="playersList">
        </ul>
    </section>


<section style="left: 0;right: 0;bottom: 10px;position: absolute;text-align: center;">
    <button id="sosButton" style="display: none;width: 80%;font-size: 18px;background: rgb(255, 85, 85);">–≠–∫—Å—Ç—Ä–µ–Ω–Ω–æ–µ —Å–æ–≤–µ—â–∞–Ω–∏–µ</button>
    <form id="startGame">
        <button type="submit" style="background: rgb(5, 165, 5);">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
    </form>
    
    <button id="lobbyLogout" style="margin-top: 10px; font-size: 16px;">–í—ã–π—Ç–∏ –∏–∑ –∏–≥—Ä—ã</button>
</section>

<script>
let lobbyID = localStorage.getItem('amongus-gameCode');
let playerName = localStorage.getItem('amongus-playerName');
let gameName = localStorage.getItem('amongus-gameName');
let impostor = $("#impostorSection");
let player = $("#playerTaskSection");
let notStarted = $("#waitTillStartSection");
let startGameButton = $("#startGame");
let sosButton = $("#sosButton");
let sabotage0 = $("#sabotage0");
let sabotage1 = $("#sabotage1");

sabotage0.click(function (event) {
    if (! sabotage0.hasClass('pause') ) {
        sabotage0.text(480);
    }
    var formData = {
        text: "‚ùóÔ∏è–ù–∞—á–∞–ª—Å—è —Å–∞–±–æ—Ç–∞–∂ –Ω–∏–∂–Ω–µ–≥–æ ‚¨áÔ∏è –∫—Ä—ã–ª–∞ (0 —ç—Ç–∞–∂)",
        name: playerName,
    };

    if (! sabotage0.hasClass('pause') ) {
        $.ajax({
            type: "POST",
            url: "http://api.board-game.space/api/among-us/send-telegram",
            data: formData,
            dataType: "json",
            encode: true,
        }).done(function (data) {
            jQuery(sabotage0).addClass("pause");
            var _Seconds = 480;
            int = setInterval(function() {
            if (_Seconds > 0) {
                if (_Seconds == 300) {
                    var formData = {
                        text: "‚ö†Ô∏è –ï—Å–ª–∏ –Ω–µ—Ç 2 –ª–∞–π–∫–æ–≤ - –≤—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏! (0 —ç—Ç–∞–∂)",
                        name: playerName,
                    };

                    $.ajax({
                        type: "POST",
                        url: "http://api.board-game.space/api/among-us/send-telegram",
                        data: formData,
                        dataType: "json",
                        encode: true,
                    });

                }
                _Seconds--;
                sabotage0.text(_Seconds);
            } else {
                jQuery(sabotage0).removeClass("pause");
                clearInterval(int);
                sabotage0.text("–°–∞–±–æ—Ç–∞–∂ –Ω–∏–∂–Ω–µ–≥–æ –∫—Ä—ã–ª–∞");
            }
            }, 1000);
        });
    }
});

sabotage1.click(function (event) {
    if (! sabotage1.hasClass('pause') ) {
        sabotage1.text(480);
    }
    var formData = {
        text: "‚ùóÔ∏è–ù–∞—á–∞–ª—Å—è —Å–∞–±–æ—Ç–∞–∂ –≤–µ—Ä—Ö–Ω–µ–≥–æ ‚¨ÜÔ∏è –∫—Ä—ã–ª–∞ (7 —ç—Ç–∞–∂)",
        name: playerName,
    };

    if (! sabotage1.hasClass('pause') ) {
        $.ajax({
            type: "POST",
            url: "http://api.board-game.space/api/among-us/send-telegram",
            data: formData,
            dataType: "json",
            encode: true,
        }).done(function (data) {
            jQuery(sabotage1).addClass("pause");
            var _Seconds = 480;
            int = setInterval(function() {
            if (_Seconds > 0) {
                if (_Seconds == 300) {
                    var formData = {
                        text: "‚ö†Ô∏è –ï—Å–ª–∏ –Ω–µ—Ç 2 –ª–∞–π–∫–æ–≤ - –≤—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏! (7 —ç—Ç–∞–∂)",
                        name: playerName,
                    };

                    $.ajax({
                        type: "POST",
                        url: "http://api.board-game.space/api/among-us/send-telegram",
                        data: formData,
                        dataType: "json",
                        encode: true,
                    });

                }
                _Seconds--;
                sabotage1.text(_Seconds);
            } else {
                jQuery(sabotage1).removeClass("pause");
                clearInterval(int);
                sabotage1.text("–°–∞–±–æ—Ç–∞–∂ –≤–µ—Ä—Ö–Ω–µ–≥–æ –∫—Ä—ã–ª–∞");
            }
            }, 1000);
        });
    }
});

sosButton.click(function (event) {
    var formData = {
        text: "üì¢ –ù–∞—á–∞—Ç–æ —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ–µ —Å–æ–≤–µ—â–∞–Ω–∏–µ",
        name: playerName,
    };

    if (! sosButton.hasClass('pause') ) {
        $.ajax({
            type: "POST",
            url: "http://api.board-game.space/api/among-us/send-telegram",
            data: formData,
            dataType: "json",
            encode: true,
        }).done(function (data) {
            jQuery(sosButton).addClass("pause");
            var _Seconds = 120;
            int = setInterval(function() {
            if (_Seconds > 0) {
                _Seconds--; 
                sosButton.text(_Seconds);
            } else {
                jQuery(sosButton).removeClass("pause");
                clearInterval(int); // –æ—á–∏—â–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª, —á—Ç–æ–±—ã –æ–Ω –Ω–µ –ø—Ä–æ–¥–æ–ª–∂–∞–ª —Ä–∞–±–æ—Ç—É –ø—Ä–∏ _Seconds = 0
                sosButton.text("–≠–∫—Å—Ç—Ä–µ–Ω–Ω–æ–µ —Å–æ–≤–µ—â–∞–Ω–∏–µ");
            }
            }, 1000);
        });
    }
});

$("#gameCode").text(lobbyID);
$("#lobbyName").text(gameName);

$("#startGame").submit(function (event) {
    var formData = {
        lobbyID: lobbyID,
        name: $("#name").val(),
        impostor: $("#impostors").val(),
    };

    $.ajax({
        type: "POST",
        url: "http://api.board-game.space/api/among-us/start-lobby",
        data: formData,
        dataType: "json",
        encode: true,
    }).done(function (data) {
        notStarted.hide();
        startGameButton.hide();
    });

    event.preventDefault();
});

$("#lobbyLogout").click(function (event) {
    var formData = {
        lobbyID: lobbyID,
        name: playerName,
    };

    $.ajax({
        type: "POST",
        url: "http://api.board-game.space/api/among-us/lobby-logout",
        data: formData,
        dataType: "json",
        encode: true,
    }).done(function (data) {
        window.location.href = "/";
    });

    event.preventDefault();
});

var colors = {
    1: '–ö—Ä–∞—Å–Ω—ã–π',
    2: '–û—Ä–∞–Ω–∂–µ–≤—ã–π',
    3: '–ö–æ—Ä–∏—á–Ω–µ–≤—ã–π',
    4: '–ñ–µ–ª—Ç—ã–π',
    5: '–°–∞–ª–∞—Ç–æ–≤—ã–π',
    6: '–ó–µ–ª–µ–Ω—ã–π',
    7: '–ì–æ–ª—É–±–æ–π',
    8: '–°–∏–Ω–∏–π',
    9: '–†–æ–∑–æ–≤—ã–π',
    10: '–§–∏–æ–ª–µ—Ç–æ–≤—ã–π',
    11: '–ß–µ—Ä–Ω—ã–π',
    12: '–ë–µ–ª—ã–π'
}

function fetchdata(){
var formData = {
    lobbyID: lobbyID,
    name: playerName,
};
var array = [];
var new_array = [];

$.ajax({
    type: "POST",
    url: "http://api.board-game.space/api/among-us/get-lobby",
    data: formData,
    dataType: "json",
    encode: true,

    success: function(data){
      localStorage.setItem('amongus-gameStatus', data.started);
    }
});

 $.ajax({
    type: "POST",
    url: "http://api.board-game.space/api/among-us/get-players",
    data: formData,
    dataType: "json",
    encode: true,

    success: function(data){
        $("#playersList").empty();
        
        let gameStatus = localStorage.getItem('amongus-gameStatus');
        $.each(data, function( index, value ) {
            $("#playersList").append("<li>" + colors[value.color] + " | " + value.name + "</li>");
            if ( gameStatus == 1 ) {
                if ( value.name == playerName ) {
                    if ( value.is_impostor == 1 ) {
                        notStarted.hide();
                        player.hide();
                        impostor.show();
                    } else {
                        notStarted.hide();
                        impostor.hide();
                        player.show();
                    }
                    startGameButton.hide();
                    sosButton.show();
                }
            }
        });
    }
 });

$.ajax({
    type: "POST",
    url: "http://api.board-game.space/api/among-us/get-tasks",
    data: formData,
    dataType: "json",
    encode: true,

    success: function(data){
      $("#playerTasksList").empty();
        if ( $.isArray(data) ) {
          $.each(data, function( index, value ) {
                if ( value.done )
                    $("#playerTasksList").append("<li style='color: rgb(5, 165, 5);'>" + value.task + "</li>");
                else
                    $("#playerTasksList").append("<li>" + value.task + "</li>");
          });
        }

        var formData = {
            lobbyID: lobbyID,
            name: playerName,
            getProgress: true,
        };

        $.ajax({
            type: "POST",
            url: "http://api.board-game.space/api/among-us/get-tasks",
            data: formData,
            dataType: "json",
            encode: true,

            success: function(data){
            var progressBar = Math.round(data);
            if ( progressBar > 0 ) {
                $("#greenBar").width(progressBar + '%');
                $("#greenBar").text(progressBar + '%');
                $("#progressBarText").text(null);

                if ( progressBar == 100 ) {
                    var formData = {
                        lobbyID: lobbyID,
                        name: playerName,
                    };
                    $.ajax({
                        type: "POST",
                        url: "http://api.board-game.space/api/among-us/get-lobby",
                        data: formData,
                        dataType: "json",
                        encode: true,

                        success: function(data){
                            if ( data.started == 1) {
                                var formData = {
                                    text: "üèÅ –ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –ü–æ–±–µ–¥–∞ –∑–∞ –∫–æ–º–∞–Ω–¥–æ–π! üë®‚Äçüë©‚Äçüëß‚Äçüë¶",
                                    name: playerName,
                                };
                                $.ajax({
                                    type: "POST",
                                    url: "http://api.board-game.space/api/among-us/send-telegram",
                                    data: formData,
                                    dataType: "json",
                                    encode: true,

                                    success: function(data){
                                        $("#playerTasksList").empty();
                                        $("#startGame").hide();
                                        $("#impostorSection").hide();
                                        $("#waitTillStartSection").hide();
                                        $("#playerTaskSection").show();
                                        $("#tasksText").text('–ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
                                        $("#gameCode").text('');
                                    }
                                });

                                var formData = {
                                    lobbyID: lobbyID,
                                    name: playerName,
                                };
                                $.ajax({
                                    type: "POST",
                                    url: "http://api.board-game.space/api/among-us/end-lobby",
                                    data: formData,
                                    dataType: "json",
                                    encode: true
                                });
                            }
                        }
                    });

                }
            }
            },
            complete:function(data){
            setTimeout(fetchdata,1000);
            }
        });

    }
});

}

$(document).ready(function(){
 setTimeout(fetchdata,0);
});


function move() {
  let elem = document.getElementById("greenBar");
  let stepValue = 20;
  let id = setInterval(frame, 500);

  function frame() {
    if (stepValue >= 100) {
      clearInterval(id);
    } else {
      elem.style.width = stepValue + 10 + "%";
      elem.innerHTML = stepValue + 10 + "%";
      stepValue = stepValue + 10;
    }
  }
}


// impostor kill button
var formData = {
    lobbyID: lobbyID,
    name: playerName,
};
$.ajax({
    type: "POST",
    url: "http://api.board-game.space/api/among-us/get-players",
    data: formData,
    dataType: "json",
    encode: true,
    success: function(data){
        $("#killPlayer").empty();
        $("#killPlayer").append("<option selected disabled>–£–±–∏—Ç—å –∏–≥—Ä–æ–∫–∞</option>");
        let gameStatus = localStorage.getItem('amongus-gameStatus');
        $.each(data, function( index, value ) {
            if (! value.is_impostor == 1 )
            if ( value.died )
                $("#killPlayer").append("<option value=" + value.id + " disabled>" + colors[value.color] + " | " + value.name + "</option>");
            else
                $("#killPlayer").append("<option value=" + value.id + ">" + colors[value.color] + " | " + value.name + "</option>");
        });
    }
});

// impostor kill button change
impostor.change(function() {
  killPlayer = $("#killPlayer").val();
  $("#killPlayer").empty();
  $("#killPlayer").append("<option selected disabled>" + 120 + "</option>");

  var formData = {
    lobbyID: lobbyID,
    playerID: killPlayer,
  };

  $.ajax({
    type: "POST",
    url: "http://api.board-game.space/api/among-us/kill-player",
    data: formData,
    dataType: "json",
    encode: true
  });

  $.ajax({
    type: "POST",
    url: "http://api.board-game.space/api/among-us/get-players",
    data: formData,
    dataType: "json",
    encode: true,

    success: function(data){
            var livePlayers = [];
            $.each(data, function( index, value ) {
                if ( ! value.died == 1 && ! value.is_impostor && value.id !== killPlayer )
                    livePlayers.push(value);
            });

            // –µ—Å–ª–∏ –æ—Å—Ç–∞–ª–æ—Å—å 2 –∏ –º–µ–Ω—å—à–µ –∏–≥—Ä–æ–∫–∞
            if ( livePlayers.length < 2 ) {
                var formData = {
                    lobbyID: lobbyID,
                    text: "üèÅ –ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –ü–æ–±–µ–¥–∞ –∑–∞ –ø—Ä–µ–¥–∞—Ç–µ–ª–µ–º! ü•∑",
                    name: playerName,
                };
                $.ajax({
                    type: "POST",
                    url: "http://api.board-game.space/api/among-us/send-telegram",
                    data: formData,
                    dataType: "json",
                    encode: true,

                    success: function(data){
                        $("#playerTasksList").empty();
                        $("#startGame").hide();
                        $("#impostorSection").hide();
                        $("#waitTillStartSection").hide();
                        $("#playerTaskSection").show();
                        $("#tasksText").text('–ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
                        $("#gameCode").text('');
                    }
                });
                $.ajax({
                    type: "POST",
                    url: "http://api.board-game.space/api/among-us/end-lobby",
                    data: formData,
                    dataType: "json",
                    encode: true
                });
            }


            jQuery($("#killPlayer")).addClass("pause");
            var _Seconds = 120;
            int = setInterval(function() {
            if (_Seconds > 0) {
                _Seconds--; 
                $("#killPlayer").empty();
                $("#killPlayer").append("<option selected disabled>" + _Seconds + "</option>");
            } else {
                $("#killPlayer").removeClass("pause");
                $("#killPlayer").empty();
                clearInterval(int);
                $.ajax({
                    type: "POST",
                    url: "http://api.board-game.space/api/among-us/get-players",
                    data: formData,
                    dataType: "json",
                    encode: true,

                    success: function(data){
                        $("#killPlayer").empty();
                        $("#killPlayer").append("<option selected disabled>–£–±–∏—Ç—å –∏–≥—Ä–æ–∫–∞</option>");
                        let gameStatus = localStorage.getItem('amongus-gameStatus');
                        $.each(data, function( index, value ) {
                          if (! value.is_impostor == 1 )
                            if ( value.died )
                                $("#killPlayer").append("<option value=" + value.id + " disabled>" + colors[value.color] + " | " + value.name + "</option>");
                            else
                                $("#killPlayer").append("<option value=" + value.id + ">" + colors[value.color] + " | " + value.name + "</option>");
                        });
                    }
                });

            }
            }, 1000);
    }
  });

});

</script>
    
</body>
</html>